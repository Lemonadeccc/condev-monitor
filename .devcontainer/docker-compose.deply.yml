services:
    condev-monitor-clickhouse:
        image: clickhouse:25.10

        expose:
            - '8123'
            - '9000'
        env_file:
            - .env
        environment:
            - CLICKHOUSE_USER=${CLICKHOUSE_USERNAME:-lemonade}
            - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-condevClickhouse}
            - CLICKHOUSE_DB=${CLICKHOUSE_DB:-lemonade}
        volumes:
            - clickhouse_data:/var/lib/clickhouse/
            - ./clickhouse/init:/docker-entrypoint-initdb.d:ro

    condev-monitor-postgres:
        image: postgres:18.1
        expose:
            - '5432'
        env_file:
            - .env
        environment:
            - POSTGRES_USER=${DB_USERNAME:-postgres}
            - POSTGRES_PASSWORD=${DB_PASSWORD:-condevPostgres}
            - POSTGRES_DB=${DB_DATABASE:-postgres}
        volumes:
            - postgres_data:/var/lib/postgresql/

    condev-monitor-server:
        build:
            context: ..
            dockerfile: apps/backend/monitor/Dockerfile
        expose:
            - '8081'
        env_file:
            - .env
        environment:
            - NODE_ENV=${NODE_ENV:-production}
            - DB_TYPE=${DB_TYPE:-postgres}
            - DB_HOST=${DB_HOST:-condev-monitor-postgres}
            - DB_PORT=${DB_PORT:-5432}
            - DB_USERNAME=${DB_USERNAME:-postgres}
            - DB_PASSWORD=${DB_PASSWORD:-condevPostgres}
            - DB_DATABASE=${DB_DATABASE:-postgres}
            - DB_AUTOLOAD=${DB_AUTOLOAD:-true}
            - DB_SYNC=${DB_SYNC:-true}
            - CLICKHOUSE_URL=${CLICKHOUSE_URL:-http://condev-monitor-clickhouse:8123}
            - FRONTEND_URL=${FRONTEND_URL:-http://localhost:8888}
            - MAIL_ON=${MAIL_ON:-false}
            - AUTH_REQUIRE_EMAIL_VERIFICATION=${AUTH_REQUIRE_EMAIL_VERIFICATION:-false}
        depends_on:
            - condev-monitor-postgres
            - condev-monitor-clickhouse

    condev-dsn-server:
        build:
            context: ..
            dockerfile: apps/backend/dsn-server/Dockerfile
        expose:
            - '8082'
        env_file:
            - .env
        environment:
            - NODE_ENV=${NODE_ENV:-production}
            - PORT=8082
            - CLICKHOUSE_URL=${CLICKHOUSE_URL:-http://condev-monitor-clickhouse:8123}
            - FRONTEND_URL=${FRONTEND_URL:-http://localhost:8888}
        depends_on:
            - condev-monitor-clickhouse

    condev-monitor-web:
        build:
            context: ..
            dockerfile: apps/frontend/monitor/Dockerfile
        expose:
            - '3000'
        environment:
            - NODE_ENV=${NODE_ENV:-production}
            - NEXT_TELEMETRY_DISABLED=1
            - API_PROXY_TARGET=http://condev-monitor-server:8081
            - DSN_API_PROXY_TARGET=http://condev-dsn-server:8082
        depends_on:
            - condev-monitor-server
            - condev-dsn-server

    condev-monitor-caddy:
        image: caddy:2.11-alpine
        ports:
            - '${CADDY_HTTP_HOST_PORT:-8888}:${CADDY_HTTP_CONTAINER_PORT:-80}'
            - '${CADDY_HTTPS_HOST_PORT:-8443}:443'
        env_file:
            - .env
        environment:
            - CADDY_HTTP_CONTAINER_PORT=${CADDY_HTTP_CONTAINER_PORT:-80}
        volumes:
            - ./caddy:/etc/caddy:ro
            - caddy_data:/data
            - caddy_config:/config
        depends_on:
            - condev-monitor-server
            - condev-monitor-web
            - condev-dsn-server

volumes:
    clickhouse_data:
    postgres_data:
    caddy_data:
    caddy_config:

services:
    condev-monitor-clickhouse:
        image: clickhouse:25.10
        container_name: condev-monitor-clickhouse
        ports:
            - '${CLICKHOUSE_HTTP_PORT:-8123}:8123'
            - '${CLICKHOUSE_NATIVE_PORT:-9000}:9000'
        env_file:
            - .env
        environment:
            - CLICKHOUSE_USER=${CLICKHOUSE_USERNAME:-lemonade}
            - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-condevClickhouse}
            - CLICKHOUSE_DB=${CLICKHOUSE_DB:-lemonade}
        volumes:
            - clickhouse_data:/var/lib/clickhouse/

    condev-monitor-postgres:
        image: postgres:18.1
        container_name: condev-monitor-postgres
        ports:
            - '${POSTGRES_PORT:-5432}:5432'
        env_file:
            - .env
        environment:
            - POSTGRES_USER=${DB_USERNAME:-postgres}
            - POSTGRES_PASSWORD=${DB_PASSWORD:-condevPostgres}
            - POSTGRES_DB=${DB_DATABASE:-postgres}
        volumes:
            - postgres_data:/var/lib/postgresql/

    condev-monitor-server:
        build:
            context: ..
            dockerfile: apps/backend/monitor/Dockerfile
        container_name: condev-monitor-server
        ports:
            - '${MONITOR_SERVER_HOST_PORT:-18081}:8081'
        env_file:
            - .env
        environment:
            - NODE_ENV=${NODE_ENV:-production}
            - DB_HOST=${DB_HOST:-condev-monitor-postgres}
            - DB_PORT=${DB_PORT:-5432}
            - CLICKHOUSE_URL=${CLICKHOUSE_URL:-http://condev-monitor-clickhouse:8123}
            - FRONTEND_URL=${FRONTEND_URL:-http://152.53.88.58:8888}
        depends_on:
            - condev-monitor-postgres
            - condev-monitor-clickhouse

    condev-dsn-server:
        build:
            context: ..
            dockerfile: apps/backend/dsn-server/Dockerfile
        container_name: condev-dsn-server
        ports:
            - '${DSN_SERVER_HOST_PORT:-18080}:8080'
        env_file:
            - .env
        environment:
            - NODE_ENV=${NODE_ENV:-production}
            - PORT=8080
            - CLICKHOUSE_URL=${CLICKHOUSE_URL:-http://condev-monitor-clickhouse:8123}
            - FRONTEND_URL=${FRONTEND_URL:-http://152.53.88.58:8888}
        depends_on:
            - condev-monitor-clickhouse

    condev-monitor-web:
        build:
            context: ..
            dockerfile: apps/frontend/monitor/Dockerfile
        container_name: condev-monitor-web
        ports:
            - '${MONITOR_WEB_HOST_PORT:-13000}:3000'
        environment:
            - NODE_ENV=${NODE_ENV:-production}
            - NEXT_TELEMETRY_DISABLED=1
            # Internal service-to-service proxy targets (avoid hardcoding host IPs)
            - API_PROXY_TARGET=http://condev-monitor-server:8081
            - DSN_API_PROXY_TARGET=http://condev-dsn-server:8080
        depends_on:
            - condev-monitor-server
            - condev-dsn-server

    condev-monitor-caddy:
        image: caddy:2.11-alpine
        container_name: condev-monitor-caddy
        ports:
            - '${CADDY_HTTP_HOST_PORT:-8888}:${CADDY_HTTP_CONTAINER_PORT:-80}'
            - '${CADDY_HTTPS_HOST_PORT:-8443}:443'
        env_file:
            - .env
        environment:
            - CADDY_HTTP_CONTAINER_PORT=${CADDY_HTTP_CONTAINER_PORT:-80}
        volumes:
            # Mount the whole directory to avoid file/dir bind-mount mismatches on hosts
            # where the source file may not exist yet (Docker would create a directory).
            - ./caddy:/etc/caddy:ro
            - caddy_data:/data
            - caddy_config:/config
        depends_on:
            - condev-monitor-server
            - condev-monitor-web
            - condev-dsn-server

volumes:
    clickhouse_data:
    postgres_data:
    caddy_data:
    caddy_config:

networks:
    default:
        name: condev-monitor-network
        driver: bridge
